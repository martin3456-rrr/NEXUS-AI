<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Notifications</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        .form-group { margin-bottom: 10px; }
        input, button { padding: 8px; font-size: 16px; }
        #messages { border: 1px solid #ccc; padding: 10px; margin-top: 20px; height: 300px; overflow-y: scroll; }
    </style>
</head>
<body>
<h1>Real-time Notifications</h1>
<div>
    <button id="connect" onclick="connect()">Connect</button>
    <button id="disconnect" disabled="disabled" onclick="disconnect()">Disconnect</button>
</div>
<div class="form-group">
    <hr>
    <h3>Broadcast to everyone:</h3>
    <input type="text" id="broadcastMessage" placeholder="Public message"/>
    <button onclick="sendBroadcast()">Send Broadcast</button>
</div>
<div class="form-group">
    <h3>Send private message:</h3>
    <input type="text" id="privateUser" placeholder="Recipient username"/>
    <input type="text" id="privateMessage" placeholder="Private message"/>
    <button onclick="sendPrivate()">Send Private</button>
</div>
<h2>Received Messages:</h2>
<div id="messages"></div>

<script type="text/javascript">
    let stompClient = null;

    function setConnected(connected) {
        document.getElementById('connect').disabled = connected;
        document.getElementById('disconnect').disabled = !connected;
    }

    function connect() {
        // NOTE: Change the URL to your actual server address
        const socket = new SockJS('/ws'); // The endpoint from WebSocketConfig
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            setConnected(true);
            console.log('Connected: ' + frame);

            // Subscribe to public broadcast topic
            stompClient.subscribe('/topic/public', function (notification) {
                showMessage(JSON.parse(notification.body).content);
            });

            // Subscribe to private reply queue for this user
            // NOTE: The '/user' prefix is handled by Spring. The client subscribes to '/user/queue/reply'
            // and the server sends to a path like '/user/{username}/queue/reply'
            stompClient.subscribe('/user/queue/reply', function (notification) {
                const msg = JSON.parse(notification.body);
                showMessage(`Private message from ${msg.from}: ${msg.content}`);
            });
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
        setConnected(false);
        console.log("Disconnected");
    }

    function sendBroadcast() {
        const content = document.getElementById('broadcastMessage').value;
        const message = {
            'from': 'client', // This should be the logged-in user in a real app
            'content': content
        };
        stompClient.send("/app/broadcast", {}, JSON.stringify(message));
    }

    function sendPrivate() {
        const user = document.getElementById('privateUser').value;
        const content = document.getElementById('privateMessage').value;
        const message = {
            'from': 'client',
            'to': user,
            'content': content
        };
        stompClient.send("/app/private", {}, JSON.stringify(message));
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const p = document.createElement('p');
        p.appendChild(document.createTextNode(message));
        messagesDiv.appendChild(p);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
